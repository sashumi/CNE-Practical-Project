pipeline {
  agent any
  stages {
    stage('Pre-Staging') {
      steps {
        sh 'pwd'
        sh 'ls -lahrt'
        sh 'ls -lahrt infrastructure/pytest_vm'
      }
    }

    stage('Terraform Deploy') {
      steps {
        sh '''cd infrastructure/pytest_vm
terraform init
terraform plan
terraform apply --auto-approve
mkdir -p ssh
aws s3 cp s3://shamsi-project2/keys/id_rsa .
chown 0700 id_rsa
eval `ssh-agent`
ssh-add id_rsa
ansible-playbook -i pytest_inventory ../ansible/pytestvm_provisioner.yml --tags all_repo,docker --skip-tags jenkins,nginx'''
      }
    }

  }
}