pipeline {
  agent any
  stages {
    stage('Test Docker Images Locally') {
      steps {
        sh '''cd product
              echo "Tear down containers"
              docker-compose down
              docker-compose up -d --build
              sleep 30
              echo "attempt backend testing"
              docker exec backend bash -c "pytest tests/ --cov application"
              echo "attempt frontend testing"
              docker exec frontend bash -c "pytest tests/ --cov application"
              docker-compose down
              echo "Remove interim images"
              docker rmi -f sashumi/cne_frontend:test sashumi/cne_backend:test sashumi/cne_database:test'''
      }
    }

    stage('Build & push images to dockerhub') {
      steps {
        sh '''mkdir -p ~/.docker
            aws s3 cp s3://shamsi-project2/keys/docker-auth-config.json ~/.docker/config.json
            ansible-playbook image_creator.yml --tags build,push '''
      }
    }
  }
}